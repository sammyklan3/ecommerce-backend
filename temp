const insertBanner = async (req, res) => {
    try {
        // Check if request contains file
        if (!req.file) {
            return res.status(400).json({ success: false, error: "No image uploaded" });
        } else if (!req.body.link) {
            return res.status(400).json({ success: false, error: "Link cannot be empty" });
        } else if (!req.body.endDate) {
            return res.status(400).json({ success: false, error: "End date cannot be empty" });
        } else if (!req.body.productId) {
            return res.status(400).json({ success: false, error: "Product Id cannot be empty" });
        }

        const { link, endDate, priority, productId } = req.body;

        // Check if a banner already exists for the given product ID
        const bannerExistsQuery = "SELECT * FROM banners WHERE ProductID = ?";
        db.query(bannerExistsQuery, [productId], (err, result) => {
            if (err) {
                console.error("Error checking if banner exists", err);
                return res.status(500).json({ success: false, error: "Internal server error" });
            }

            if (result.length > 0) {
                return res.status(400).json({ success: false, error: "A banner already exists for this product" });
            }

            // Format end date as a MySQL date string (YYYY-MM-DD HH:MM:SS)
            const formattedEndDate = new Date(endDate).toISOString().slice(0, 19).replace('T', ' ');

            const insertBannerQuery = `
                INSERT INTO banners (ImageName, Link, StartDate, EndDate, Priority, ProductID) 
                VALUES (?, ?, NOW(), ?, ?, ?)
            `;

            db.query(insertBannerQuery, [req.file.filename, link, formattedEndDate, priority, productId], (err, result) => {
                if (err) {
                    console.error("Error inserting banner", err);
                    res.status(500).json({ success: false, error: "Internal server error" });
                } else {
                    res.status(201).json({ success: true, message: "Banner inserted successfully" });
                }
            });
        });
    } catch (err) {
        console.log(err);
        res.status(500).json({ success: false, error: "An error occurred" });
    }
}
